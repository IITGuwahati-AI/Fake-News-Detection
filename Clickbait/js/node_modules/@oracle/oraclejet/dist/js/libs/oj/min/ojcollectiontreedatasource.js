/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","jquery","ojs/ojmodel","ojs/ojdatasource-common"],function(e,t,o){"use strict";return e.CollectionNodeSet=function(e,t,o,n,c,l){this.parentKey=e,this.collection=t,this.models=o,this.childNodeSet=[],this.treeDataSource=n,c<o.length?this.start=c:0===o.length?this.start=0:this.start=o.length-1,this.count=-1===l?o.length:Math.min(o.length,l)},e.CollectionNodeSet.prototype.FetchDescendants=function(e){this._fetchDescendants(this).then(function(){e.success&&e.success()})},e.CollectionNodeSet.prototype._fetchDescendants=function(e){return new Promise(function(t){var o=e.getCount();!function n(c){c<o?e.FetchChildNodeSet(c,{success:function(t){null!==t?e._fetchDescendants(t).then(function(){n(c+1)}):n(c+1)}}):t(void 0)}(0)})},e.CollectionNodeSet.prototype.FetchChildNodeSet=function(e,t){var o=this.models[e];if(this.treeDataSource.parseMetadata(o).leaf)return this.childNodeSet[e]=null,void t.success(null);var n=this.treeDataSource.GetChildCollection(o),c=this.treeDataSource.parseMetadata(o).key,l=this;this.treeDataSource.FetchCollection(n,0,-1,{success:function(o){l.childNodeSet[e]=o,t.success(o)}},c)},e.CollectionNodeSet.prototype._getCollection=function(){return this.collection},e.CollectionNodeSet.prototype.getParent=function(){return this.parentKey},e.CollectionNodeSet.prototype.getStart=function(){return this.start},e.CollectionNodeSet.prototype.getCount=function(){return this.count},e.CollectionNodeSet.prototype.getData=function(e){return this._checkRange(e),this.models[e].attributes},e.CollectionNodeSet.prototype._checkRange=function(e){if(e<this.start||e>this.start+this.count)throw new Error("Out of range")},e.CollectionNodeSet.prototype.getMetadata=function(e){this._checkRange(e);var t={leaf:!1,depth:-1},o=this.models[e],n=this.treeDataSource.parseMetadata(o);return t.key=n.key,t.leaf=n.leaf,t.depth=n.depth,t},e.CollectionNodeSet.prototype.getChildNodeSet=function(e){return this.treeDataSource._virtual?null:(this._checkRange(e),this.childNodeSet[e])},e.CollectionTreeDataSource=function(t){t=t||{},this.rootCollection=t.root,this.childCollectionCallback=t.childCollectionCallback,this.parseMetadata=t.parseMetadata,this.sortkey=null,this.sortdir="none",this.cache={},this._virtual=!1,e.CollectionTreeDataSource.superclass.constructor.call(this)},e.CollectionTreeDataSource.prototype.parseMetadata=function(e){return{key:e.idAttribute+"="+e.id}},e.Object.createSubclass(e.CollectionTreeDataSource,e.TreeDataSource,"oj.CollectionTreeDataSource"),e.CollectionTreeDataSource.prototype.Init=function(){e.CollectionTreeDataSource.superclass.Init.call(this)},e.CollectionTreeDataSource.prototype.getChildCount=function(e){var t=this.__getParentsChildCollectionFromCache(e);return t&&t.length>0?t.length:-1},e.CollectionTreeDataSource.prototype.getChildCollection=function(e,t){this.fetchChildren(e,null,{success:function(e){t.success(e._getCollection())},error:t.error})},e.CollectionTreeDataSource.prototype.fetchChildren=function(e,t,o,n){var c=(t=t||{}).start?t.start:0,l=t.count?t.count:-1;if(null!==e){var i=this;this._getModelForId(this.rootCollection,c,l,e,0).then(function(t){if(t){var n=i.GetChildCollection(t.model);try{i.FetchCollection(n,c,l,o,e)}catch(e){o&&o.error&&o.error({status:e.message})}}else o&&o.error&&o.error(e)})}else this.FetchCollection(null,c,l,o,null)},e.CollectionTreeDataSource.prototype.ModelAdded=function(e,t,o){var n=0;o&&o.at&&(n=o.at);var c=this._getParentChain(t),l=null!=c&&c.length>0?c[c.length-1]:null,i=this._createEvent(this,"insert",n,c,this._putModelInNodeSet(l,e));this.handleEvent("change",i)},e.CollectionTreeDataSource.prototype.ModelRemoved=function(e,t,o){var n=0;o&&o.index&&(n=o.index),this._removeCollectionFromCache(e);var c=this._createEvent(this,"delete",n,this._getParentChain(t),null);this.handleEvent("change",c)},e.CollectionTreeDataSource.prototype.ModelUpdated=function(e,t){var o=e.collection,n=e.GetIndex(),c=null;o&&(c=this._getParentChain(o));var l=null!=c&&c.length>0?c[c.length-1]:null,i=this._createEvent(this,"update",n,c,this._putModelInNodeSet(l,e));this.handleEvent("change",i)},e.CollectionTreeDataSource.prototype.CollectionRefreshed=function(e,t,o){var n=this._createEvent(this,"refresh",null,this._getParentChain(e),null);this.handleEvent("refresh",n)},e.CollectionTreeDataSource.prototype._putModelInNodeSet=function(e,t){var n=new o.Collection;return n.add(t),this._getNodeSet(n,e,0,1,[t])},e.CollectionTreeDataSource.prototype._getParentChain=function(t){var o=[],n=null,c=t;do{null!==(n=this._getParentOfCollection(c))&&(n!==e.CollectionTreeDataSource.ROOT_CACHE_KEY&&o.unshift(n),c=this._getCollectionOfKey(n))}while(null!=n);return o},e.CollectionTreeDataSource.ROOT_CACHE_KEY="%!@ROOT%#@!",e.CollectionTreeDataSource.prototype._getCacheKey=function(t){var n=t instanceof o.Model?this.parseMetadata(t).key:t;return null!=t?n:e.CollectionTreeDataSource.ROOT_CACHE_KEY},e.CollectionTreeDataSource.prototype.__getParentsChildCollectionFromCache=function(e){return this.cache[this._getCacheKey(e)]},e.CollectionTreeDataSource.prototype._setCollectionInCache=function(e,t){t.on(o.Events.EventType.ADD,this.ModelAdded,this),t.on(o.Events.EventType.REMOVE,this.ModelRemoved,this),t.on(o.Events.EventType.CHANGE,this.ModelUpdated,this),t.on(o.Events.EventType.SYNC,this.CollectionRefreshed,this);var n=this._getCacheKey(e);return this.cache[n]=t,this.cache[n]},e.CollectionTreeDataSource.prototype._removeCollectionFromCache=function(e){for(var t=this._getCacheKey(e),o=Object.keys(this.cache),n=0;n<o.length;n++){if(o[n]===t)return this.cache[t].off(null,null,this),void delete this.cache[t]}},e.CollectionTreeDataSource.prototype._keyInCollection=function(e,t){for(var o=t.length,n=null,c=0;c<o;c++){if(n=t.models[c])if(e===this._getCacheKey(n))return!0}return!1},e.CollectionTreeDataSource.prototype._getCollectionOfKey=function(e){for(var t=Object.keys(this.cache),o=0;o<t.length;o++){var n=t[o],c=this.cache[n];if(this._keyInCollection(e,c))return c}return null},e.CollectionTreeDataSource.prototype._getParentOfCollection=function(e){for(var t=Object.keys(this.cache),o=0;o<t.length;o++){var n=t[o];if(this.cache[n]===e)return n}return null},e.CollectionTreeDataSource.prototype.GetChildCollection=function(e){var t=!0,o=this.__getParentsChildCollectionFromCache(e);return o||(t=!1,null!=(o=this.childCollectionCallback(this.rootCollection,e))&&(this._applySortToCollection(o),this._setCollectionInCache(e,o))),{collection:o,cached:t}},e.CollectionTreeDataSource.prototype._createEvent=function(e,t,o,n,c){return{source:e,operation:t,index:o,parent:n,data:c}},e.CollectionTreeDataSource.prototype.FetchCollection=function(e,t,o,n,c){var l=this;null===e&&((e=this.__getParentsChildCollectionFromCache(null))?e={collection:e,cached:!0}:(e={collection:l.rootCollection,cached:!1},l._setCollectionInCache(null,this.rootCollection))),e&&l._fetch(e,t,o,function(e,i){e.IsVirtual()&&(l._virtual=!0),n.success&&n.success(l._getNodeSet(e,c,t,o,i))},n.error)},e.CollectionTreeDataSource.prototype._getNodeSet=function(t,o,n,c,l){return new e.CollectionNodeSet(o,t,l,this,n,c)},e.CollectionTreeDataSource.prototype._scanForKey=function(e,t){var o=this,n=new Array(e.length);return new Promise(function(c){!function t(l,i,r){l<e.length?i.at(l,{deferred:!0}).then(function(e){if(n[l]=e,e){var a=o.parseMetadata(e);if(r===a.key)return void c({model:e,models:n})}t(l+=1,i,r)}):c({model:null,models:n})}(0,e,t)})},e.CollectionTreeDataSource.prototype._getModelForId=function(e,t,o,n,c){var l=this;return new Promise(function(i){l._scanForKey(e,n).then(function(e){e.model?i({model:e.model,depth:c}):function r(a,s,h){if(a<s.length){var u=l.__getParentsChildCollectionFromCache(s[a]);u?h._fetch({collection:u,cached:!0},t,o,function(e,l){h._getModelForId(e,t,o,n,c+1).then(function(e){e?i(e):r(a+=1,s,h)})},null):r(a+=1,s,h)}else!function e(r,a,s){var h;r<a.length?(l.parseMetadata(a[r]).leaf||(h=s.GetChildCollection(a[r])),h&&h.collection?s._fetch(h,t,o,function(l,h){s._getModelForId(l,t,o,n,c+1).then(function(t){t?i(t):e(r+=1,a,s)})},null):e(r+=1,a,s)):i(null)}(0,e.models,l)}(0,e.models,l)})})},e.CollectionTreeDataSource.prototype._getModelsFromCollection=function(e){if(e.IsVirtual()){var t=new Array(e.length);return new Promise(function(o){(function(e,t,o,n){return new Promise(function(c,l){var i,r=function(t){return new Promise(function(o,c){e.at(t).then(function(e){n[t]=e,o(t+1)},c)})},a=Promise.resolve(0);for(i=t;i<o;i++)a=a.then(r);return a.then(c,l)})})(e,0,e.length,t).then(function(){o(t)})})}return new Promise(function(t){t(e.models)})},e.CollectionTreeDataSource.prototype._fetch=function(e,t,o,n,c){var l=this;if(e.cached)this._getModelsFromCollection(e.collection).then(function(t){n(e.collection,t)});else{if(this.sortkey&&"none"!==this.sortkey&&(e.collection.comparator=this.sortkey,e.collection.sortDirection=this.sortdir),e.collection.length>0||!e.collection.IsUrlBased(null))return void n(e.collection,e.collection.models);-1===o?(e.collection.modelLimit=-1,e.collection.fetch({success:function(e){l._getModelsFromCollection(e).then(function(t){n(e,t)})},error:c})):(e.collection.modelLimit=-1,e.collection.setRangeLocal(t,o).then(function(t){e.models=t.models,n(e.collection,t.models)}))}},e.CollectionTreeDataSource.prototype.fetchDescendants=function(t,o,n){this._virtual&&e.Assert.failedInAbstractFunction();var c=this;null!==t?this._getModelForId(this.rootCollection,0,-1,t,0).then(function(e){if(e){var n=c.GetChildCollection(e.model);c.FetchCollection(n,0,-1,{success:function(e){e.FetchDescendants({success:function(){o.success&&o.success(e)}})}},t)}}):this.FetchCollection(null,0,-1,{success:function(e){e.FetchDescendants({success:function(){o.success&&o.success(e)}})}},null)},e.CollectionTreeDataSource.prototype.sort=function(e,t){var o=e.key,n=e.direction,c=!1;if(o!==this.sortkey&&(this.sortkey=o,c=!0),n!==this.sortdir&&(this.sortdir=n,c=!0),c){"none"===this.sortdir&&(this.cache={});for(var l=Object.keys(this.cache),i=0;i<l.length;i++){var r=l[i],a=this.cache[r];this._applySortToCollection(a)}}t&&t.success&&t.success()},e.CollectionTreeDataSource.prototype._applySortToCollection=function(e){e.comparator=this.sortkey,e.sortDirection="ascending"===this.sortdir?1:-1,e.sort()},e.CollectionTreeDataSource.prototype.getSortCriteria=function(){return{key:this.sortkey,direction:this.sortdir}},e.CollectionTreeDataSource.prototype.move=function(t,o,n,c){e.Assert.failedInAbstractFunction()},e.CollectionTreeDataSource.prototype.moveOK=function(e,t,o){return"invalid"},e.CollectionTreeDataSource.prototype.getCapability=function(e){return"sort"===e?"default":"move"===e?"none":"batchFetch"===e?"disable":"fetchDescendants"===e?"disable":null},e.CollectionTreeDataSource});