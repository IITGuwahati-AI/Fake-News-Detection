/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","ojs/ojhtmlutils","ojs/ojlogger","promise","ojs/ojcustomelement","ojs/ojcomposite-knockout"],function(e,t,o){"use strict";e.Composite={};e.Composite;return e.Composite.getMetadata=function(t){o.error("Composite.getMetadata('"+t+"'): This method is scheduled for removal.  Call Composite.getComponentMetadata instead.");var r=e.Composite.getComponentMetadata(t);return r?Promise.resolve(r):null},e.Composite.getComponentMetadata=function(t){var o=e.BaseCustomElementBridge.getRegistered(t);return o&&o.composite?e.BaseCustomElementBridge.__GetDescriptor(t)[e.BaseCustomElementBridge.DESC_KEY_META]:null},e.Composite.register=function(t,o){e.CompositeElementBridge.register(t,o)},e.Composite.getContainingComposite=function(t,o){for(var r=null,i=t;i;)if((i=e.CompositeTemplateRenderer.getEnclosingComposite(i))&&"oj-module"!==i.nodeName.toLowerCase()){if(o&&!(16&t.compareDocumentPosition(o)))break;r=i}return r},e.Composite.getBindingProviderName=function(t){return t?t[e.Composite.__BINDING_PROVIDER]:null},e.Composite.__COMPOSITE_PROP="__oj_composite",e.Composite.__BINDING_PROVIDER="__oj_binding_prvdr",e.CompositeElementBridge={},e.CompositeElementBridge.proto=Object.create(e.BaseCustomElementBridge.proto),e.CollectionUtils.copyInto(e.CompositeElementBridge.proto,{beforePropertyChangedEvent:function(t,o,r){var i={property:o};e.CollectionUtils.copyInto(i,r),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"propertyChanged",[i])},AddComponentMethods:function(t){var o=function(t,o,r,i,n,s){if(!o.SaveEarlyPropertySet(r,i)){var a=o.SetProperty(t,r,i,n,s);if(a.propertySet)if(a.isSubproperty)e.CompositeElementBridge._getPropertyTracker(o,a.property).valueHasMutated()}};t.setProperty=function(t,r){var i=e.BaseCustomElementBridge.getInstance(this);o(this,i,t,r,this,!0)},t.getProperty=function(t){return e.BaseCustomElementBridge.getInstance(this).GetProperty(this,t,this)},t._propsProto.setProperty=function(e,t){o(this._ELEMENT,this._BRIDGE,e,t,this,!1)},t._propsProto.getProperty=function(e){return this._BRIDGE.GetProperty(this,e,this)},t.getNodeBySubId=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getNodeBySubId?r.getNodeBySubId(t,o._getNodeBySubId.bind(this)):o._getNodeBySubId.bind(this)(t)},t.getSubIdByNode=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getSubIdByNode?r.getSubIdByNode(t,o._getSubIdByNode.bind(this)):o._getSubIdByNode.bind(this)(t)}},CreateComponent:function(t){for(var r={},i=e.BaseCustomElementBridge.getSlotMap(t),n=Object.keys(i),s=0;s<n.length;s++){var a=n[s];r[a]=i[a].length}this._SLOT_MAP=i;var d={element:t,props:Promise.resolve(this._PROPS),properties:this._PROPS,slotNodeCounts:Promise.resolve(r),slotCounts:r,unique:e.BaseCustomElementBridge.__GetUnique()};d.uniqueId=t.id?t.id:d.unique,this._VM_CONTEXT=d;var m=e.BaseCustomElementBridge.__GetDescriptor(t.tagName)[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL];if("function"==typeof m)m=new m(d);else{var u=e.BaseCustomElementBridge.getElementInfo(t);m&&o.error(u+": ViewModel should be specified as a constructor function.  Support for all other types is scheduled for removal.");m=e.CompositeTemplateRenderer.invokeViewModelMethod(m,"initialize",[d],function(){return u+": The ViewModel 'initialize' callback is scheduled for removal.  ViewModel should be specified as a constructor function."})||m}this._VIEW_MODEL=m;var l=e.CompositeTemplateRenderer.invokeViewModelMethod(m,"activated",[d])||Promise.resolve(!0),p=this;l.then(function(){var o={props:p._PROPS,slotMap:p._SLOT_MAP,slotNodeCounts:r,unique:p._VM_CONTEXT.unique,uniqueId:p._VM_CONTEXT.uniqueId,viewModel:p._VIEW_MODEL,viewModelContext:p._VM_CONTEXT};Object.defineProperty(t,e.Composite.__BINDING_PROVIDER,{value:"knockout"}),e.Components&&e.Components.unmarkPendingSubtreeHidden(t);var i=e.BaseCustomElementBridge.__GetCache(t.tagName),n=e.CompositeElementBridge._getDomNodes(i.view,t);e.CompositeTemplateRenderer.renderTemplate(o,t,n),p.__READY_TO_FIRE=!0,p.resolveDelayedReadyPromise()}).catch(function(e){p.throwError(t,e)})},DefineMethodCallback:function(t,o,r){t[o]=function(){var t=r.internalName||o,i=e.BaseCustomElementBridge.getInstance(this)._getViewModel(this);return i[t].apply(i,arguments)}},DefinePropertyCallback:function(t,r,i){var n=function(t,n){if(!this._BRIDGE.SaveEarlyPropertySet(r,t)){var s=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,r),a=s.peek();if(e.BaseCustomElementBridge.__CompareOptionValues(r,i,t,a))o.info(e.BaseCustomElementBridge.getElementInfo(this._ELEMENT)+": Ignoring property set for property '"+r+"' with same value.");else if(n&&(t=this._BRIDGE.ValidatePropertySet(this._ELEMENT,r,t)),i._eventListener&&this._BRIDGE.SetEventListenerProperty(this._ELEMENT,r,t),s(t),!i._derived){var d=n?"external":"internal";e.BaseCustomElementBridge.__FirePropertyChangeEvent(this._ELEMENT,r,t,a,d)}}},s=function(t){var o=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,r),n=t?o.peek():o();return void 0===n&&o(n=this._BRIDGE.GetDefaultValue(i)),n};i._derived||e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t._propsProto,r,function(){return s.bind(this,!1)()},function(e){n.bind(this)(e,!1)}),e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t,r,function(){var t=e.BaseCustomElementBridge.getInstance(this);return s.bind(t._PROPS,!0)()},function(t){var o=e.BaseCustomElementBridge.getInstance(this);n.bind(o._PROPS)(t,!0)})},GetMetadata:function(e){return e._metadata},GetTrackChildrenOption:function(){return"immediate"},HandleDetached:function(t){e.BaseCustomElementBridge.proto.HandleDetached.call(this,t);e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"detached",[t],function(){return e.BaseCustomElementBridge.getElementInfo(t)+": The ViewModel 'detached' callback is scheduled for removal.  Use the 'disconnected' callback instead."}),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"disconnected",[t])},HandleReattached:function(t){e.BaseCustomElementBridge.proto.HandleReattached.call(this,t),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"connected",[this._VM_CONTEXT])},InitializeElement:function(t){var r;e.BaseCustomElementBridge.proto.InitializeElement.call(this,t),e.Components&&e.Components.markPendingSubtreeHidden(t);var i=e.BaseCustomElementBridge.__GetCache(t.tagName);if(!i.view){var n=(r=e.BaseCustomElementBridge.__GetDescriptor(t.tagName))[e.BaseCustomElementBridge.DESC_KEY_VIEW];i.view||("string"==typeof n?i.view=e.CompositeElementBridge._getDomNodes(n,t):(o.error(e.BaseCustomElementBridge.getElementInfo(t)+": View should be passed as a string.  Support for all other types is scheduled for removal."),i.view=n))}if(!i.css){r||(r=e.BaseCustomElementBridge.__GetDescriptor(t.tagName));var s=r[e.BaseCustomElementBridge.DESC_KEY_CSS];if(s){var a=document.createElement("style");a.type="text/css",a.styleSheet?a.styleSheet.cssText=s:a.appendChild(document.createTextNode(s)),document.head.appendChild(a),i.css=!0}}e.BaseCustomElementBridge.__InitProperties(t,t)},InitializePrototype:function(t){e.BaseCustomElementBridge.proto.InitializePrototype.call(this,t),Object.defineProperty(t,"_propsProto",{value:{}})},InitializeBridge:function(t){e.BaseCustomElementBridge.proto.InitializeBridge.call(this,t),t._propsProto&&(this._PROPS=Object.create(t._propsProto),this._PROPS._BRIDGE=this,this._PROPS._ELEMENT=t)},_getNodeBySubId:function(t){var o=e.CompositeElementBridge.__GetSubIdMap(this)[t.subId];if(o){if(o.alias){var r=e.CollectionUtils.copyInto({},t,void 0,!0);r.subId=o.alias;var i=o.node;return i.getNodeBySubId?i.getNodeBySubId(r):e.Components.__GetWidgetConstructor(i)("getNodeBySubId",r)}return o.node}return null},_getSubIdByNode:function(t){if(!this.contains(t))return null;var o,r,i,n=e.CompositeElementBridge.__GetNodeMap(this),s=e.Composite.getContainingComposite(t,this);if(null!=s){if((r=n[o=s.node.getAttribute("data-oj-subid-map")])&&s.getSubIdByNode&&(i=s.getSubIdByNode(t))){var a=r.map[i.subId];return i.subId=a,i}return null}for(var d=t;d!==this&&!(o=d.getAttribute("data-oj-subid-map")||d.getAttribute("data-oj-subid"));)d=d.parentNode;if(r=n[o]){if(!r.map)return{subId:o};var m=r.node;if(i=m.getSubIdByNode?m.getSubIdByNode(t):e.Components.__GetWidgetConstructor(m)("getSubIdByNode",t))return i.subId=r.map[i.subId],i}return null},_getViewModel:function(e){return this._VIEW_MODEL||this.throwError(e,"Cannot access methods before element is upgraded."),this._VIEW_MODEL}}),e.CompositeElementBridge.register=function(t,r){var i={};if(i[e.BaseCustomElementBridge.DESC_KEY_META]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_META),i[e.BaseCustomElementBridge.DESC_KEY_VIEW]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_VIEW),r[e.BaseCustomElementBridge.DESC_KEY_CSS]&&o.error(t+": Component CSS should be loaded using the require-css RequireJS CSS plugin"),i[e.BaseCustomElementBridge.DESC_KEY_CSS]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_CSS),i[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL),i[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN]=r[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN],e.BaseCustomElementBridge.__Register(t,i,e.CompositeElementBridge.proto,!0)){var n=i[e.BaseCustomElementBridge.DESC_KEY_META];if(n||(o.warn("Composite registered'"+t.toLowerCase()+"' without Metadata."),n={}),null==i[e.BaseCustomElementBridge.DESC_KEY_VIEW])throw new Error("Cannot register composite '"+t.toLowerCase()+"' without a View.");i._metadata=e.BaseCustomElementBridge.__ProcessEventListeners(n,!1),customElements.define(t.toLowerCase(),e.CompositeElementBridge.proto.getClass(i))}},e.CompositeElementBridge._getDomNodes=function(o,r){var i,n;if("string"==typeof o)return t.stringToNodeArray(o);if(e.CompositeElementBridge._isDocumentFragment(o)){n=o.cloneNode(!0);var s=[];for(i=0;i<n.childNodes.length;i++)s.push(n.childNodes[i]);return s}if(Array.isArray(o)){for(n=[],i=0;i<o.length;i++)n.push(o[i].cloneNode(!0));return n}e.BaseCustomElementBridge.getInstance(r).throwError(r,"The composite View is not one of the following supported types: string, Array of DOM nodes, DocumentFragment")},e.CompositeElementBridge._generateSubIdMap=function(t,o){if(!t._SUBID_MAP){for(var r={},i={},n=o.children,s=0;s<n.length;s++)e.CompositeElementBridge._walkSubtree(r,i,n[s]);t._NODE_MAP=i,t._SUBID_MAP=r}},e.CompositeElementBridge._walkSubtree=function(t,o,r){if(!r.hasAttribute("slot")&&(e.CompositeElementBridge._addNodeToSubIdMap(t,o,r),!e.BaseCustomElementBridge.getRegistered(r.tagName)&&!e.Components.__GetWidgetConstructor(r)))for(var i=r.children,n=0;n<i.length;n++)e.CompositeElementBridge._walkSubtree(t,o,i[n])},e.CompositeElementBridge._addNodeToSubIdMap=function(e,t,o){var r=o.getAttribute("data-oj-subid"),i=o.getAttribute("data-oj-subid-map");if(i){var n=JSON.parse(i);if("object"==typeof n&&!(n instanceof Array)){for(var s=n,a={},d=Object.keys(s),m=0;m<d.length;m++){var u=d[m];e[u]={alias:s[u],node:o},a[s[u]]=u}t[i]={map:a,node:o}}}else r&&(e[r]={node:o},t[r]={node:o})},e.CompositeElementBridge.__GetSubIdMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._SUBID_MAP},e.CompositeElementBridge.__GetNodeMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._NODE_MAP},e.CompositeElementBridge._getPropertyTracker=function(t,o){return t._TRACKERS||(t._TRACKERS={}),t._TRACKERS[o]||(t._TRACKERS[o]=e.CompositeTemplateRenderer.createTracker()),t._TRACKERS[o]},e.CompositeElementBridge._getResource=function(t,r){var i=t[r];if(null!=i){var n=Object.prototype.hasOwnProperty;if(n.call(i,"inline"))return o.error(e.CompositeElementBridge._getResourceErrorMessage(r,"inline","scheduled for removal")),i.inline;if(n.call(i,"promise"))throw new Error(e.CompositeElementBridge._getResourceErrorMessage(r,"promise","no longer supported"));return i}},e.CompositeElementBridge._getResourceErrorMessage=function(e,t,o){return"The '"+t+"' resource type for descriptor key '"+e+"' is "+o+". The resource should be passed directly as the value instead."},e.CompositeElementBridge._isDocumentFragment=function(e){return window.DocumentFragment?e instanceof DocumentFragment:e&&11===e.nodeType},e.Composite});