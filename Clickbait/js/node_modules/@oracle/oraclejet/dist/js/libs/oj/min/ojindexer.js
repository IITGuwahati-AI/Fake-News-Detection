/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","jquery","hammerjs","ojs/ojcontext","ojs/ojtranslation","promise","ojs/ojjquery-hammer","ojs/ojcomponentcore"],function(e,t,n,r,i){"use strict";var s={properties:{data:{type:"object"},translations:{type:"object",value:{},properties:{ariaDisabledLabel:{type:"string"},ariaInBetweenText:{type:"string"},ariaKeyboardInstructionText:{type:"string"},ariaOthersLabel:{type:"string"},ariaTouchInstructionText:{type:"string"},indexerCharacters:{type:"string"},indexerOthers:{type:"string"}}}},methods:{refresh:{},setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},extension:{}};e.IndexerModel=function(){},e.IndexerModel.SECTION_OTHERS={id:"__others__",label:i.getTranslatedString("oj-ojIndexer.indexerOthers")},e.ListViewIndexerModel=function(e){this.listview=e,this.Init()},e.Object.createSubclass(e.ListViewIndexerModel,e.EventSource,"oj.ListViewIndexerModel"),e.ListViewIndexerModel.prototype.getIndexableSections=function(){return this.listview.ojContext.getTranslatedString("indexerCharacters").split("|")},e.ListViewIndexerModel.prototype.getMissingSections=function(){return null==this.missingSections&&(this.missingSections=this._getMissingSections()),this.missingSections},e.ListViewIndexerModel.prototype._getMissingSections=function(){var e,n=[],r=this.listview._getGroupItemsCache(),i=this.getIndexableSections();for(e=0;e<i.length;e++){var s=i[e],a=!1;r.each(function(){var e=t(this).text();return!(e.length>0&&e.charAt(0)===s)||(a=!0,!1)}),a||n.push(s)}return n},e.ListViewIndexerModel.prototype.setSection=function(t){return t===e.IndexerModel.SECTION_OTHERS?this._setOtherSection():this._setSection(t)},e.ListViewIndexerModel.prototype._setOtherSection=function(){var n=this.getIndexableSections(),r=this;return new Promise(function(i){var s=null;r.listview._getGroupItemsCache().each(function(){for(var e=t(this).text(),r=0;r<n.length;r++){var i=n[r];if(0===e.indexOf(i))return!0}return s=this,!1}),s?(r.listview._scrollToGroupHeader(s),i(e.IndexerModel.SECTION_OTHERS)):i(null)})},e.ListViewIndexerModel.prototype._setSection=function(e){var t=this.getIndexableSections(),n=t.indexOf(e),r=this;return new Promise(function(e){if(-1===n)e(null);else{for(var i=null;n<t.length;n++){var s=t[n],a=r._findGroupHeader(s);if(null!=a){r.listview._scrollToGroupHeader(a),i=s;break}}e(i)}})},e.ListViewIndexerModel.prototype._findGroupHeader=function(e){var n;return this.listview._getGroupItemsCache().each(function(){return 0!==t(this).text().indexOf(e)||(n=this,!1)}),n},e.__registerWidget("oj.ojIndexer",t.oj.baseComponent,{defaultElement:"<ul>",version:"1.2",widgetEventPrefix:"oj",options:{data:null},_ComponentCreate:function(){this._super(),this._setup()},_AfterCreate:function(){this._super(),this._createIndexerContent(),this._setAriaProperties(),this._createInstructionText()},_destroy:function(){this._super();var t=this._getIndexerContainer();this._unregisterResizeListener(t),this._unregisterTouchHandler(t),this._unsetAriaProperties(),this.element.removeClass("oj-component-initnode"),e.DomUtils.unwrap(this.element,t)},_setOption:function(e,t){this._superApply(arguments),"data"===e&&this.refresh()},_SetupResources:function(){this._super();var e=this._getIndexerContainer()[0];this._registerResizeListener(e),this._registerTouchHandler(e)},_ReleaseResources:function(){this._super();var e=this._getIndexerContainer()[0];this._unregisterResizeListener(e),this._unregisterTouchHandler(e),this._resolveBusyState()},_resolveBusyState:function(){this.busyStateResolve&&(this.busyStateResolve(null),this.busyStateResolve=null)},widget:function(){return this._getIndexerContainer()},refresh:function(){this._super(),this.element.empty(),this._createIndexerContent(),this._setAriaProperties(),this.m_current=null},getNodeBySubId:function(e){if(null==e)return this.element?this.element[0]:null;if("oj-indexer-section"===e.subId)for(var n=e.section,r=this.element.children("li"),i=0;i<r.length;i++){var s=r.get(i);if(t(s).data("data-range")===n)return s;var a=t(s).data("data-includes");if(null!=a)for(var o=0;o<a.length;o++)if(a[o]===n)return s}return null},getSubIdByNode:function(e){if(null!=e){var n=t(e).data("data-range");if(null!=n)return{subId:"oj-indexer-section",section:n}}return null},_setAriaProperties:function(){this.element.attr("role","slider").attr("aria-orientation","vertical").attr("aria-describedby",this.element.prop("id")+":desc").attr("aria-valuemin",0).attr("aria-valuemax",Math.max(0,this.element.children().length-1))},_unsetAriaProperties:function(){this.element.removeAttr("role").removeAttr("aria-orientation").removeAttr("aria-describedby").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuetext")},_createInstructionText:function(){var n;n=e.DomUtils.isTouchSupported()?"ariaTouchInstructionText":"ariaKeyboardInstructionText";var r=t(document.createElement("div"));r.prop("id",this.element.prop("id")+":desc"),r.addClass("oj-helper-hidden-accessible").text(this.getTranslatedString(n)),this._getIndexerContainer().append(r)},_getIndexerContainer:function(){return null==this.m_container&&(this.m_container=this._createIndexerContainer()),this.m_container},_createIndexerContainer:function(){var e;return this.OuterWrapper?e=t(this.OuterWrapper):(e=t(document.createElement("div")),this.element.parent()[0].replaceChild(e[0],this.element[0])),e.addClass("oj-indexer oj-component"),e.prepend(this.element),e},_createIndexerContent:function(){var e=this._getIndexerModel();if(null!=e){var t,n=this.element,r=e.getIndexableSections();e.getMissingSections&&(t=e.getMissingSections());var i=this.getTranslatedString("indexerOthers"),s=this.widget().outerHeight(),a=this._createItem(r[0],t);n.append(a);var o=a.outerHeight(),l=Math.floor(s/o);this._getIndexerContainer().removeClass("oj-indexer-abbr");var u=Math.floor((r.length+1)/l)+1;u>1&&this._getIndexerContainer().addClass("oj-indexer-abbr");for(var d=1+u;d<r.length;d=d+u+1){if(u>1){var h=this._createSeparator(r,d-u,d-1);n.append(h)}else d-=1;var c=r[d],_=this._createItem(c,t);n.append(_)}var g=this._createItem(r[r.length-1],t);n.append(g);var f=this._createItem(i);f.attr("data-others","true"),n.append(f)}},_createItem:function(e,n){var r=e.label?e.label:e,i=t(document.createElement("li"));return i.data("data-range",e).text(r),null!=n&&n.indexOf(e)>-1&&i.addClass("oj-disabled"),i},_createSeparator:function(e,n,r){var i=[],s=t(document.createElement("li"));s.addClass("oj-indexer-ellipsis").data("data-range",e[n+Math.round((r-n)/2)]);for(var a=n;a<=r;a++)i.push(e[a]);return s.data("data-includes",i),s},_setup:function(){var e=this;this.element.uniqueId().addClass("oj-component-initnode").attr("tabIndex",0),this._on(this.element,{click:function(t){e._handleClick(t)},keydown:function(t){e._handleKeyDown(t)},focus:function(t){e._handleFocus(t)},blur:function(t){e._handleBlur(t)}}),this._focusable({applyHighlight:!0,setupHandlers:function(t,n){e._focusInHandler=t,e._focusOutHandler=n}})},_handleClick:function(e){var n;0===e.button&&(n=t(e.target),this._setCurrent(n))},_handleFocus:function(e){this._getIndexerContainer().addClass("oj-focus-ancestor"),null==this.m_current?this._setFocus(this.element.children("li").first()):this._setFocus(this.m_current)},_handleBlur:function(e){this._getIndexerContainer().removeClass("oj-focus-ancestor")},_handleKeyDown:function(e){var t,n=!1;switch(e.keyCode){case 38:t=this.m_current.prev();break;case 40:t=this.m_current.next();break;case 13:this._setCurrent(this.m_current),n=!0}null!=t&&t.length>0&&(n=!0,this._setFocus(t)),n&&e.preventDefault()},_setFocus:function(e){null!=this.m_current&&this._focusOutHandler(this.m_current),this._focusInHandler(e),this._updateAriaProperties(e),this.m_current=e},_getIndexerModel:function(){var e=this.option("data");if(null!=e&&(void 0===e.setSection||void 0===e.getIndexableSections))throw new Error("Invalid IndexerModel");return e},_setCurrent:function(t){var n=t.data("data-range");t.attr("data-others")&&(n=e.IndexerModel.SECTION_OTHERS),this._setCurrentSection(n)},_setCurrentSection:function(e){var t=this,n=r.getContext(this.element[0]).getBusyContext();this.busyStateResolve=n.addBusyState({description:"setCurrentSection"}),this._getIndexerModel().setSection(e).then(function(e){if(null!=e){var n=t._findItem(e);null!=n&&t._setFocus(n)}t._resolveBusyState()},function(){t._resolveBusyState()})},_updateAriaProperties:function(t){var n=t.data("data-includes"),r="";if(null!=n){if(n.length>0){var i=n[0].label?n[0].label:n[0],s=n[n.length-1].label?n[n.length-1].label:n[n.length-1];r=this.getTranslatedString("ariaInBetweenText",{first:i,second:s})}}else{var a=t.data("data-range");r=a===e.IndexerModel.SECTION_OTHERS?this.getTranslatedString("ariaOthersLabel"):a}t.hasClass("oj-disabled")&&(r=r+". "+this.getTranslatedString("ariaDisabledLabel")),this.element.attr("aria-valuetext",r),this.element.attr("aria-valuenow",t.index())},_findItem:function(e){for(var n=this.element.children(),r=0;r<n.length;r++){var i=n.get(r),s=t(i).data("data-range"),a=t(i).data("data-includes");if(null!=s&&s===e||null!=a&&a.indexOf(e)>-1)return t(i)}return null},_unregisterResizeListener:function(t){t&&this._resizeHandler&&e.DomUtils.removeResizeListener(t,this._resizeHandler)},_registerResizeListener:function(t){t&&(null==this._resizeHandler&&(this._resizeHandler=this._handleResize.bind(this)),e.DomUtils.addResizeListener(t,this._resizeHandler))},_unregisterTouchHandler:function(e){this.hammer&&(this.hammer.off("panstart panmove panend"),t(e).ojHammer("destroy")),this.hammer=null},_registerTouchHandler:function(e){var r,i,s,a,o,l=this,u={recognizers:[[n.Pan,{direction:n.DIRECTION_VERTICAL}]]};this.hammer=t(e).ojHammer(u).on("panstart",function(e){var n=e.gesture.target;r=l.element[0].getBoundingClientRect().left+5,i=n.getBoundingClientRect().top,l._setCurrent(t(n)),s=n,a=t(n).data("data-range"),o=i}).on("panmove",function(e){var n=o;o=i+e.gesture.deltaY;var u=document.elementFromPoint(r,o);if(null!=u){var d,h,c=o-n;if(s===u){if(null!=(d=t(u).data("data-includes"))){var _=d.indexOf(a);h=null,c>0&&_<d.length-1?h=d[_+1]:c<0&&_>0&&(h=d[_-1]),null!=h&&(a=h,l._setCurrentSection(h))}}else t(u).data("data-range")&&(h=null,null!=(d=t(u).data("data-includes"))&&(c>0&&u===s.nextElementSibling?h=d[0]:c<0&&u===s.previousElementSibling&&(h=d[d.length-1])),null==h&&(h=t(u).data("data-range")),s=u,a=h,l._setCurrentSection(a))}}).on("panend",function(){s=null,a=null,o=null})},_handleResize:function(e,t){e>0&&t>0&&this.refresh()}}),s.extension._WIDGET_NAME="ojIndexer",s.extension._INNER_ELEM="ul",e.CustomElementBridge.register("oj-indexer",{metadata:s})});