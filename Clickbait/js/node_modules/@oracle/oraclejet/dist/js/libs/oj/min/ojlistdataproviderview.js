/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovider","ojs/ojcomponentcore","ojs/ojeventtarget","ojs/ojdataprovider"],function(t,e,n){"use strict";var r=function(){function e(t,n){this.dataProvider=t,this.options=n,this._noFilterSupport=!1,this.AsyncIterable=function(){return function(t,e){this._parent=t,this._asyncIterator=e,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(t,e,n){this._parent=t,this._nextFunc=e,this._params=n}return t.prototype.next=function(){var t=this._nextFunc(this._params);return Promise.resolve(t)},t}(),this.AsyncIteratorResult=function(){return function(t,n,r){this._parent=t,this.value=n,this.done=r,this[e._VALUE]=n,this[e._DONE]=r}}(),this.FetchListResult=function(){return function(t,n,r,i){this._parent=t,this.fetchParameters=n,this.data=r,this.metadata=i,this[e._FETCHPARAMETERS]=n,this[e._DATA]=r,this[e._METADATA]=i}}(),this.Item=function(){return function(t,n,r){this._parent=t,this.metadata=n,this.data=r,this[e._METADATA]=n,this[e._DATA]=r}}(),this.ItemMetadata=function(){return function(t,n){this._parent=t,this.key=n,this[e._KEY]=n}}(),this.FetchListParameters=function(){return function(t,n,r,i,s){this._parent=t,this.size=n,this.sortCriteria=r,this.filterCriterion=i,this.attributes=s,this[e._SIZE]=n,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=i,this[e._FETCHATTRIBUTES]=s}}(),this.FetchByKeysParameters=function(){return function(t,n,r){this._parent=t,this.keys=n,this.attributes=r,this[e._KEYS]=n,this[e._FETCHATTRIBUTES]=r}}(),this.FetchByOffsetParameters=function(){return function(t,n,r,i,s,a){this._parent=t,this.offset=n,this.size=r,this.sortCriteria=i,this.filterCriterion=s,this.attributes=a,this[e._SIZE]=r,this[e._SORTCRITERIA]=i,this[e._OFFSET]=n,this[e._FILTERCRITERION]=s,this[e._FETCHATTRIBUTES]=a}}(),this.FetchByKeysResults=function(){return function(t,n,r){this._parent=t,this.fetchParameters=n,this.results=r,this[e._FETCHPARAMETERS]=n,this[e._RESULTS]=r}}(),this.ContainsKeysResults=function(){return function(t,n,r){this._parent=t,this.containsParameters=n,this.results=r,this[e._CONTAINSPARAMETERS]=n,this[e._RESULTS]=r}}(),this.FetchByOffsetResults=function(){return function(t,n,r,i){this._parent=t,this.fetchParameters=n,this.results=r,this.done=i,this[e._FETCHPARAMETERS]=n,this[e._RESULTS]=r,this[e._DONE]=i}}(),this[e._FROM]=null==this.options?null:this.options[e._FROM],this[e._OFFSET]=null==this.options?0:this.options[e._OFFSET]>0?this.options[e._OFFSET]:0,this[e._SORTCRITERIA]=null==this.options?null:this.options[e._SORTCRITERIA],this[e._DATAMAPPING]=null==this.options?null:this.options[e._DATAMAPPING],this[e._FETCHATTRIBUTES]=null==this.options?null:this.options[e._FETCHATTRIBUTES],this[e._FILTERCRITERION]=null==this.options?null:this.options[e._FILTERCRITERION],this._addEventListeners(t),t.getCapability&&!t.getCapability("filter")&&(this._noFilterSupport=!0)}return e.prototype.containsKeys=function(t){var n=this;return this.dataProvider[e._CONTAINSKEYS]?this.dataProvider[e._CONTAINSKEYS](t):this.fetchByKeys(t).then(function(r){var i=new Set;return t[e._KEYS].forEach(function(t){null!=r[e._RESULTS].get(t)&&i.add(t)}),Promise.resolve(new n.ContainsKeysResults(n,t,i))})},e.prototype.fetchByKeys=function(t){var n=this,r=null!=t?t[e._KEYS]:null,i=null!=t?t[e._FETCHATTRIBUTES]:null;null==i&&(i=this[e._FETCHATTRIBUTES]);var s=new n.FetchByKeysParameters(n,r,i);if(this.dataProvider[e._FETCHBYKEYS])return this.dataProvider[e._FETCHBYKEYS](s).then(function(t){var r=t[e._RESULTS],i=new Map;return r.forEach(function(t,e){var r=n._getMappedItems([t]);i.set(e,r[0])}),new n.FetchByKeysResults(n,s,i)});var a=new this.FetchListParameters(this,e._DEFAULT_SIZE,null,null,i),u=new Map,_=this.dataProvider[e._FETCHFIRST](a)[Symbol.asyncIterator]();return this._fetchNextSet(t,_,u).then(function(t){var e=new Map;return t.forEach(function(t,r){var i=n._getMappedItems([t]);e.set(r,i[0])}),new n.FetchByKeysResults(n,s,e)})},e.prototype.fetchByOffset=function(t){var n=this,r=null!=t?t[e._OFFSET]:null,i=null!=t?t[e._SIZE]:null,s=null!=t?t[e._FETCHATTRIBUTES]:null;null==s&&(s=this[e._FETCHATTRIBUTES]);var a=null!=t?t[e._SORTCRITERIA]:null;null==a&&(a=this[e._SORTCRITERIA]);var u=this._getMappedSortCriteria(a),_=null!=t?t[e._FILTERCRITERION]:null,o=this._getMappedFilterCriterion(_),T=new n.FetchByOffsetParameters(n,r,i,u,o,s);return this.dataProvider[e._FETCHBYOFFSET](T).then(function(t){var r=t[e._RESULTS],i=t[e._DONE],s=new Array;return r.forEach(function(t){var e=n._getMappedItems([t]);s.push(e[0])}),new n.FetchByOffsetResults(n,T,s,i)})},e.prototype.fetchFirst=function(t){var n={};n[e._ITEMS]=[],n[e._DONE]=!1,n[e._STARTINDEX]=0;var r=null!=t?t[e._SIZE]:null,i=null!=t?t[e._SORTCRITERIA]:null;null==i&&(i=this[e._SORTCRITERIA]);var s=this._getMappedSortCriteria(i),a=null!=t?t[e._FILTERCRITERION]:null;null==a&&(a=this[e._FILTERCRITERION]);var u=this._getMappedFilterCriterion(a),_=null!=t?t[e._FETCHATTRIBUTES]:null;null==_&&(_=this[e._FETCHATTRIBUTES]);var o=this;if(null==o[e._FROM]&&o[e._OFFSET]>0){var T=o[e._OFFSET];return new this.AsyncIterable(this,new this.AsyncIterator(this,function(t){return function(){var n=new o.FetchByOffsetParameters(o,T,r,s,u,_);return o.dataProvider[e._FETCHBYOFFSET](n).then(function(n){var i=n.results;T+=i.length;var s=o._getMappedItems(i);o._cacheResult(t,s),t[e._DONE]=n[e._DONE];var a=s.map(function(t){return t[e._DATA]}),u=s.map(function(t){return t[e._METADATA]}),_=n[e._FETCHPARAMETERS],l=null!=_?_[e._SORTCRITERIA]:null,E=null!=_?_[e._FILTERCRITERION]:null,h=o._getUnmappedSortCriteria(l),A=o._getUnmappedFilterCriterion(E),R=new o.FetchByOffsetParameters(o,o[e._OFFSET],r,h,A);return Promise.resolve(new o.AsyncIteratorResult(o,new o.FetchListResult(o,R,a,u),t[e._DONE]))})}}(n),t))}var l=new this.FetchListParameters(this,r,s,u,_),E=this.dataProvider[e._FETCHFIRST](l)[Symbol.asyncIterator]();return new this.AsyncIterable(this,new this.AsyncIterator(this,function(n,r){return function(){return r.next().then(function(i){var s=i[e._VALUE][e._DATA],a=i[e._VALUE][e._METADATA],_=s.map(function(t,e){return new o.Item(o,a[e],s[e])});o._noFilterSupport&&o._filterResult(u,_);var T=o._getMappedItems(_);o._cacheResult(n,T),n[e._DONE]=i[e._DONE];var l=null!=t?t[e._SIZE]:null,E=(null!=t&&t[e._OFFSET],i[e._VALUE][e._FETCHPARAMETERS]),h=null!=E?E[e._SORTCRITERIA]:null,A=null!=E?E[e._FILTERCRITERION]:null,R=o._getUnmappedSortCriteria(h),I=o._getUnmappedFilterCriterion(A),f=new o.FetchListParameters(o,l,R,I);return o._fetchUntilKey(f,o[e._FROM],n,r).then(function(){return o._fetchUntilOffset(f,o[e._OFFSET]+n[e._STARTINDEX],s.length,n,r)})})}}(n,E),t))},e.prototype.getCapability=function(t){return this.dataProvider.getCapability(t)},e.prototype.getTotalSize=function(){return this.dataProvider.getTotalSize()},e.prototype.isEmpty=function(){return this.dataProvider.isEmpty()},e.prototype._fetchNextSet=function(n,r,i){var s=this;return r.next().then(function(a){var u=a[e._VALUE],_=u[e._DATA],o=u[e._METADATA],T=o.map(function(t){return t[e._KEY]}),l=!0;return n[e._KEYS].forEach(function(e){i.has(e)||T.map(function(n,r){t.Object.compareValues(n,e)&&i.set(e,new s.Item(s,o[r],_[r]))}),i.has(e)||(l=!1)}),l||a[e._DONE]?i:s._fetchNextSet(n,r,i)})},e.prototype._fetchUntilKey=function(n,r,i,s){var a=this;if(null!=r){var u=i[e._ITEMS].filter(function(n){if(t.KeyUtils.equals(n[e._METADATA][e._KEY],r))return!0});if(u.length>0){var _=i[e._ITEMS].indexOf(u[0]);i[e._ITEMS]=i[e._ITEMS].slice(_,i[e._ITEMS].length)}else{if(!i[e._DONE])return s.next().then(function(t){var n=t[e._VALUE][e._DATA],r=t[e._VALUE][e._METADATA],u=n.map(function(t,e){return new a.Item(a,r[e],n[e])}),_=a._getMappedItems(u);return a._cacheResult(i,_),i[e._DONE]=t[e._DONE],a._fetchUntilKey(t[e._FETCHPARAMETERS],_[e._KEYS],i,s)});i[e._ITEMS]=[]}}return Promise.resolve(null)},e.prototype._fetchUntilOffset=function(t,n,r,i,s){var a=this,u=null!=t&&t[e._SIZE]>0?t[e._SIZE]:r;n=n>0?n:0;var _=i[e._ITEMS].slice(n,n+u);if(this._noFilterSupport){var o=this._getMappedFilterCriterion(t[e._FILTERCRITERION]);this._filterResult(o,_)}if(_.length<u){if(i[e._DONE]){i[e._STARTINDEX]=i[e._STARTINDEX]+_.length;var T=_.map(function(t){return t[e._DATA]}),l=_.map(function(t){return t[e._METADATA]});return Promise.resolve(new a.AsyncIteratorResult(a,new a.FetchListResult(a,t,T,l),!0))}return s.next().then(function(r){var u=r[e._VALUE][e._DATA],_=r[e._VALUE][e._METADATA],o=u.map(function(t,e){return new a.Item(a,_[e],u[e])});if(a._noFilterSupport){var T=a._getMappedFilterCriterion(t[e._FILTERCRITERION]);a._filterResult(T,o)}var l=a._getMappedItems(o);return a._cacheResult(i,l),i[e._DONE]=r[e._DONE],a._fetchUntilOffset(r[e._VALUE][e._FETCHPARAMETERS],n,u.length,i,s)})}i[e._STARTINDEX]=i[e._STARTINDEX]+_.length;T=_.map(function(t){return t[e._DATA]}),l=_.map(function(t){return t[e._METADATA]});return Promise.resolve(new a.AsyncIteratorResult(a,new a.FetchListResult(a,t,T,l),i[e._DONE]))},e.prototype._cacheResult=function(t,n){n.map(function(n){t[e._ITEMS].push(n)})},e.prototype._filterResult=function(t,r){if(t){t.filter||(t=n.FilterFactory.getFilter({filterDef:t}));for(var i=r.length-1;i>=0;)t.filter(r[i][e._DATA])||r.splice(i,1),i--}},e.prototype._getMappedItems=function(t){var n=this;if(null!=this[e._DATAMAPPING]){var r=this[e._DATAMAPPING][e._MAPFIELDS];if(null!=r&&null!=t&&t.length>0){new Array;return t.map(function(t){return r.bind(n)(t)})}}return t},e.prototype._getMappedFilterCriterion=function(t){if(null!=this[e._DATAMAPPING]){var n=this[e._DATAMAPPING][e._MAPFILTERCRITERION];if(null!=n&&null!=t)return n(t)}return t},e.prototype._getMappedSortCriteria=function(t){if(null!=this[e._DATAMAPPING]){var n=this[e._DATAMAPPING][e._MAPSORTCRITERIA];if(null!=n&&null!=t&&t.length>0)return n(t)}return t},e.prototype._getUnmappedSortCriteria=function(t){if(null!=this[e._DATAMAPPING]){var n=this[e._DATAMAPPING][e._UNMAPSORTCRITERIA];if(null!=n&&null!=t&&t.length>0)return n(t)}return t},e.prototype._getUnmappedFilterCriterion=function(t){if(null!=this[e._DATAMAPPING]){var n=this[e._DATAMAPPING][e._UNMAPFILTERCRITERION];if(null!=n&&null!=t)return n(t)}return t},e.prototype._addEventListeners=function(t){var n=this;t[e._ADDEVENTLISTENER](e._REFRESH,function(t){n.dispatchEvent(t)}),t[e._ADDEVENTLISTENER](e._MUTATE,function(t){n.dispatchEvent(t)})},e._KEY="key",e._KEYS="keys",e._DATA="data",e._STARTINDEX="startIndex",e._SORT="sort",e._SORTCRITERIA="sortCriteria",e._FILTERCRITERION="filterCriterion",e._METADATA="metadata",e._ITEMS="items",e._FROM="from",e._OFFSET="offset",e._REFRESH="refresh",e._MUTATE="mutate",e._SIZE="size",e._FETCHPARAMETERS="fetchParameters",e._VALUE="value",e._DONE="done",e._DATAMAPPING="dataMapping",e._MAPFIELDS="mapFields",e._MAPSORTCRITERIA="mapSortCriteria",e._MAPFILTERCRITERION="mapFilterCriterion",e._UNMAPSORTCRITERIA="unmapSortCriteria",e._UNMAPFILTERCRITERION="unmapFilterCriterion",e._RESULTS="results",e._CONTAINSPARAMETERS="containsParameters",e._DEFAULT_SIZE=25,e._CONTAINSKEYS="containsKeys",e._FETCHBYKEYS="fetchByKeys",e._FETCHBYOFFSET="fetchByOffset",e._FETCHFIRST="fetchFirst",e._ADDEVENTLISTENER="addEventListener",e._FETCHATTRIBUTES="attributes",e}();return t.ListDataProviderView=r,t.ListDataProviderView=r,t.EventTargetMixin.applyMixin(r),r});