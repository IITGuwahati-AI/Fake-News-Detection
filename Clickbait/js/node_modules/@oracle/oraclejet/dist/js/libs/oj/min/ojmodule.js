/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","knockout","ojs/ojlogger","ojs/ojcontext","promise"],function(e,n,i,o){"use strict";e.ModuleBinding={};e.ModuleBinding;return e.ModuleBinding.defaults={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"},e.ModuleBinding._EMPTY_MODULE="oj:blank",function(){function t(e,i,o){var t=i||e,l=[];o&&e===t&&(o.parentNode.removeChild(o),l.push(o)),n.virtualElements.setDomNodeChildren(t,l)}function l(e,n){e.forEach(function(e){n.appendChild(e)})}function r(e,n,i){var o={};i[0]&&(o.viewModel=i[0]),i[1]&&(o.view=i[1]);var t=new CustomEvent(n,{detail:o});e.dispatchEvent(t)}function d(e,i,o){if(e&&e[i]){var t={element:o[0],valueAccessor:o[1]};return o.length>2&&(t.viewModel=o[2],o.length>3&&(t["boolean"==typeof o[3]?"fromCache":"cachedNodes"]=o[3])),n.ignoreDependencies(e[i],e,[t])}}function a(i,o,t){if(null!=i){var l=e.ModuleBinding.defaults[o];if(null!=l&&i){var r,d=i[l];if("function"==typeof d)return t&&(r={element:t[0],valueAccessor:t[1]},t.length>2&&(r["boolean"==typeof t[2]?"fromCache":"cachedNodes"]=t[2])),n.ignoreDependencies(d,i,[r])}}}function u(e,i){if(e&&i){var o=e[i];"function"==typeof o&&n.ignoreDependencies(o,e)}}function s(e,i,o){for(var t=e;null!=t;){var l=n.virtualElements.nextSibling(t),r=t.nodeType;t===i||1!==r&&8!==r||o(t),t=l}}function c(e,i){for(var o=i.length-1;o>=0;o--)n.virtualElements.prepend(e,i[o])}function f(e,n){if(n)for(var i=0;i<e.length;i++){var o=e[i];1===o.nodeType&&n(o)}}function v(e,n,o){var t=e||require,l=new Promise(function(e,n){t([o],e,n)});return l=l.catch(function(e){throw i.error("ojModule failed to load "+o),e})}n.bindingHandlers.ojModule={init:function(p,h,m,w,g){var M,C,b,E,y,N,P,V,j={},D=-1,A=p.parentNode&&"OJ-MODULE"===p.parentNode.nodeName,B=A?function(){}:a,H=A?function(){}:d,$=A?u:function(){},x=A?r:function(){};function T(){N&&(N(),N=null)}var F=function(e){B(e,"disposeMethod",[p,h])},O=function(){F(M)};n.utils.domNodeDisposal.addDisposeCallback(p,function(){O();for(var e=Object.keys(j),n=0;n<e.length;n++){var i=j[e[n]].model;F(i)}T()});var S=new Error("Promise cancelled because ojModule is fetching new View and ViewModel"),k=function(e){if(e!==D)throw S},L=p;return 8===p.nodeType&&(L=p.parentNode,n.virtualElements.setDomNodeChildren(p,[]),y=p.nextSibling),n.computed(function(){if(D+=1,!N){var r=o.getContext(L).getBusyContext();N=r.addBusyState({description:"ojModule binding on a node with the Id "+p.id+"is loading the module. Binding evaluator: "+h.toString()})}var d,a,u,m,w,F,q,I,U,_,z,J,Y,K,R=0===D,W=n.utils.unwrapObservable,G=W(h());"string"==typeof G?d=G:(d=W(G.name),a=W(G.viewName),u=W(G.params),m=W(G.viewModelFactory),w=W(G.createViewFunction),F=W(G.cacheKey),q=W(G.lifecycleListener),I=W(G.animation),J=W(G.view),Y=W(G.viewModel),U=W(G.require),K=W(G.cleanupMode)),null==U||U instanceof Function||(z=U.viewPath,_=U.modelPath,U=U.instance),a=null==a?d:a;var Q,X,Z,ee,ne=e.ModuleBinding._EMPTY_MODULE===a,ie=H(q,"activated",[p,h]);if(x(L,"ojTransitionStart",[Y]),ne?(Q=Promise.resolve([]),X=Promise.resolve(null)):null!=(Z=null==F?null:j[F])&&(delete j[F],Q=Promise.resolve(Z.view),X=Promise.resolve(Z.model)),null==Q&&null!=J&&(Q=Promise.resolve(J)),null==X&&(null!=Y?X=Promise.resolve(Y):null!=m&&(X=n.ignoreDependencies(m.createViewModel,m,[u,h])),null==X&&null!=d&&(null==_&&(_=e.ModuleBinding.defaults.modelPath),X=v(U,"viewModel",_+d)),null!=X&&(X=X.then(function(e,n){return k(e),n="function"==typeof n?new n(u):B(n,"initializeMethod",[p,h])||n}.bind(null,D)),null==Q&&null!=w&&(Q=X.then(function(e,n){if(k(e),null==n)throw T(),new Error("createViewFunction option cannot be used when the ViewModel is null");var i=n[w];if(null==i)throw T(),new Error("function specified by the createViewFunction option was not found on the ViewModel");return i.call(n)}.bind(null,D)))),null==Q)){if(null==a)throw T(),new Error("View name or view instance must be specified");null==z&&(z=e.ModuleBinding.defaults.viewPath),Q=v(U,"view",z+a+e.ModuleBinding.defaults.viewSuffix)}if(null==Q)throw T(),new Error("ojModule is missing a View");null!=X&&(ee=X.then(function(e,n){return k(e),B(n,"activatedHandler",[p,h])}.bind(null,D))),Promise.all([Q,X,ie,ee,C]).then(function(o,r){if(o===D){var d=r[0];if(null==d)throw T(),new Error("The module's View was resolved to null");var a,v=function(e,i){var o=e;if("string"==typeof o)o=n.utils.parseHtmlFragment(o,document);else if(function(e){if(window.DocumentFragment)return e instanceof DocumentFragment;return e&&11===e.nodeType}(o))o=n.utils.arrayPushAll([],o.childNodes);else{if(!Array.isArray(o))throw i(),new Error("The View ("+o+") has an unsupported type");o=n.utils.arrayPushAll([],o)}return o}(d,T),m=r[1],w=!1,N=function(e,i,o){for(var t=[],l=n.virtualElements.firstChild(e);null!=l&&l!==o;l=l.nextSibling)l!==i&&t.push(l);return t}(p,E,y),S=function(e,i){var o=[];return s(n.virtualElements.firstChild(e),i,function(e){o.push(e)}),o}(p,E);null==b||P?A&&(a=N):(w=!0,a=N,E||((E=document.createElement("div")).className="oj-helper-module-cache",n.virtualElements.prepend(p,E)));var k=!1,U=function(i){if(!k){if(k=!0,w)l(N,E),t(p,i||p,E);else if(A&&"none"===V)for(var o=0;o<a.length;o++){var r=a[o];r.parentNode.removeChild(r)}else S.forEach(function(e){n.cleanNode(e)}),t(p,i||p,E);R||(H(q,"detached",[p,h,M,a]),B(M,"detachedHandler",[p,h,a]),$(M,"disconnected"),x(L,"ojViewDisconnected",[M,a]),H(q,"deactivated",[p,h,M]),B(M,"deactivatedHandler",[p,h])),w?(f(a,e.Components?e.Components.subtreeHidden:null),j[b]={model:M,view:a}):A&&"none"===V?f(a,e.Components?e.Components.subtreeDetached:null):O(),M=m,b=F,P=ne,V=K}},_=function(){H(q,"transitionCompleted",[p,h,m]),B(m,"transitionCompletedHandler",[p,h]),$(m,"transitionCompleted"),x(L,"ojTransitionEnd",[m]),T()};if(null!=I){var z=function(o,t,r,d,a,u,s){var v,p,h=o,m=t.canAnimate;if(null!=m&&!m.call(t,h))return;var w=t.prepareAnimation.call(t,h);w&&(v=w.newViewParent,p=w.oldViewParent);var g=v||r;p&&p!==r?l(d,p):g===r&&u(null);g!==r&&n.virtualElements.setDomNodeChildren(g,[]);a(g);var M=Array.prototype.slice.call(g.childNodes),C=!1,b=function(){if(!C&&(C=!0,r!==g)){c(r,M);var n=r.parentNode&&"OJ-MODULE"===r.parentNode.nodeName;e.Components&&!n&&(f(M,e.Components.subtreeDetached),f(M,e.Components.subtreeAttached))}},E=u.bind(null,p);h.newViewParent=v,h.oldViewParent=p,h.oldViewNodes=d,h.removeOldView=E,h.insertNewView=b;var y=function(){E(),b(),s()};return t.animate.call(t,h).then(y,function(){y(),i.error("ojModule animation promise was rejected")})}(function(e,n,i,o,t,l){return{node:l?e.parentNode:e,valueAccessor:l?null:n,isInitial:i,oldViewModel:o,newViewModel:t}}(p,h,R,M,m,A),I,p,N,J,U,_);C=function(e){if(!e)return e;return new Promise(function(n,i){e.then(n,n)})}(z)}else C=void 0;C||(U(null),J(null),_())}function J(i){var o=i||p,t=A&&function(e,i){for(var o,t=0;t<e.length&&!(o=n.contextFor(e[t]));t++);return o&&o.$module&&o.$module===i}(v,m);c(o,v);var l=null!=Z;if(l?f(v,e.Components?e.Components.subtreeShown:null):t&&f(v,e.Components?e.Components.subtreeAttached:null),H(q,"attached",[o,h,m,l]),B(m,"attachedHandler",[o,h,l]),$(m,"connected"),x(L,"ojViewConnected",[m]),!l&&!t){var r=g.createChildContext(m,void 0,function(e){e.$module=m,e.$params=u});A&&(r.$parent=void 0,r.$parents=void 0,r.$parentContext=void 0,r.$props=void 0,r.$properties=void 0,r.$slotNodeCounts=void 0,r.$slotCounts=void 0,r.$unique=void 0,r.$uniqueId=void 0),function(e,i,o,t){var l=n.bindingProvider.instance,r=l.preprocessNode;r&&(s(i,t,function(e){r.call(l,e)}),i=n.virtualElements.firstChild(e));s(i,t,function(e){n.applyBindings(o,e)})}(o,v[0],r,E),H(q,"bindingsApplied",[o,h,m]),B(m,"bindingsAppliedHandler",[o,h])}}}.bind(null,D),function(e,n){n!==S&&null!=n&&(T(),i.error(n))}.bind(null,D))},null,{disposeWhenNodeIsRemoved:p}),{controlsDescendantBindings:!0}}},n.virtualElements.allowedBindings.ojModule=!0}(),e.ModuleBinding});