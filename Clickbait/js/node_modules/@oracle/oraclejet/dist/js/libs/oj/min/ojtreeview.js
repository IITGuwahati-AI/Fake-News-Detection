/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["require","ojs/ojcore","jquery","ojs/ojcontext","ojs/ojthemeutils","ojs/ojcomponentcore","ojs/ojanimation","ojs/ojlogger","ojs/ojconfig","ojs/ojkeyset","ojdnd"],function(e,t,n,i,r,s,a,o,l){"use strict";var d={properties:{currentItem:{type:"any",writeback:!0,readOnly:!0},data:{type:"object"},dnd:{type:"object",properties:{drag:{type:"object",properties:{items:{type:"object",properties:{dataTypes:{type:"string|Array<string>"},dragStart:{type:"function"},drag:{type:"function"},dragEnd:{type:"function"}}}}},drop:{type:"object",properties:{items:{type:"object",properties:{dataTypes:{type:"string|Array<string>"},dragEnter:{type:"function"},dragOver:{type:"function"},dragLeave:{type:"function"},drop:{type:"function"}}}}}}},expanded:{type:"KeySet",writeback:!0,value:"new ExpandedKeySet()"},item:{type:"object",properties:{focusable:{type:"function"},renderer:{type:"function"},selectable:{type:"function"}}},selection:{type:"Array<any>",writeback:!0,value:[]},selectionMode:{type:"string",enumValues:["multiple","none","single"],value:"none"},translations:{type:"object",value:{}}},methods:{getContextByNode:{},refresh:{},setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},events:{ojAnimateEnd:{},ojAnimateStart:{},ojBeforeCollapse:{},ojBeforeCurrentItem:{},ojBeforeExpand:{},ojCollapse:{},ojExpand:{}},extension:{}};t.__registerWidget("oj.ojTreeView",n.oj.baseComponent,{version:"1.0.0",defaultElement:"<div>",widgetEventPrefix:"oj",options:{currentItem:null,data:null,dnd:{drag:null,drop:null},expanded:new t.ExpandedKeySet,item:{focusable:null,renderer:null,selectable:null},selection:[],selectionMode:"none",animateEnd:null,animateStart:null,beforeCollapse:null,beforeCurrentItem:null,beforeExpand:null,collapse:null,expand:null},_ComponentCreate:function(){this._super()},_AfterCreate:function(){this._super(),this._initRender(),this._render()},_initRender:function(){var e=this;this._on(this.element,{click:function(t){e._handleClick(t)},mouseover:function(t){e._handleMouseOver(t)},mouseout:function(t){e._handleMouseOut(t)},mousedown:function(t){e._handleMouseDown(t)},mouseup:function(t){e._handleMouseUp(t)},keydown:function(t){e._handleKeyDown(t)},dragstart:function(t){e._handleDragStart(t)},drag:function(t){e._handleDragSourceEvent(t,"drag")},dragend:function(t){e._handleDragSourceEvent(t,"dragEnd")},dragenter:function(t){e._handleDropTargetEvent(t,"dragEnter")},dragover:function(t){e._handleDropTargetEvent(t,"dragOver")},dragleave:function(t){e._handleDropTargetEvent(t,"dragLeave")},drop:function(t){e._handleDropTargetEvent(t,"drop")}}),t.DomUtils.isTouchSupported()&&(this.element[0].addEventListener("touchstart",function(t){e.touchStartEvent=t}),this.element[0].addEventListener("touchcancel",function(){e.touchStartEvent=null}),this.element[0].addEventListener("touchend",function(t){e.touchStartEvent&&t.changedTouches.length&&document.elementFromPoint(t.changedTouches[0].clientX,t.changedTouches[0].clientY)!==e.touchStartEvent.target&&(e.touchStartEvent=null),e._handleMouseOut(t)}));var i=n(document.createElement("span")).addClass("oj-treeview-drop-marker-icon oj-component-icon");this._dropMarker=n(document.createElement("div")).addClass("oj-treeview-drop-marker").append(i).appendTo(this.element),this._dropMarkerRect=this._dropMarker[0].getBoundingClientRect(),this._dropMarker.hide(),this._dropLine=n(document.createElement("div")).addClass("oj-treeview-drop-line").appendTo(this.element),this._dropLineRect=this._dropLine[0].getBoundingClientRect(),this._dropLine.hide(),this._refreshId=0,this._uiExpanded=new t.ExpandedKeySet},_render:function(){var e=this;this.element.removeClass("oj-complete"),this._keyList=new Set,this.options.data?(this.element.find("ul").remove(),this._fetchChildren(null,function(t){var n=t[0];e._renderItems(n.value,e.element),e._resetFocus(),e.element.addClass("oj-complete"),e._decorateTree(),e._lastSelectedItem=null})):(this.element.find("ul").addClass("oj-treeview-list").attr("role","group"),this.element.find("li").each(function(){var t=n(this);e._decorateItem(t)}),this._resetFocus(),this.element.addClass("oj-complete"),this._decorateTree(),this._lastSelectedItem=null)},_getDataProvider:function(){var n;if(null==this.m_dataSource){if(n=this.options.data,!t.DataProviderFeatureChecker.isTreeDataProvider(n)){var i=t.__getRequirePromise("./ojtreedataprovideradapter",e);if(!i)throw new Error("Cannot adapt a TreeDataSource if require() is not available");return i.then(function(e){return new e(n)})}}else n=this.m_dataSource;return Promise.resolve(n)},_fetchChildren:function(e,t){var n=this,i=n._addBusyState("getting data provider"),r=n._getDataProvider(),s=this._refreshId;r.then(function(r){if(i(),n._refreshId===s){n.m_dataSource=r;var a=null===e?r:r.getChildDataProvider(e);if(null!=a){var l=n._addBusyState("fetching data"),d=n._loadTemplateEngine(),h=a.fetchFirst({size:-1})[Symbol.asyncIterator](),u=h.next(),c=function(e){return e[0].done?e:h.next().then(function(t){return n._refreshId!==s?null:(e[0].done=t.done,e[0].value.data=e[0].value.data.concat(t.value.data),e[0].value.metadata=e[0].value.metadata.concat(t.value.metadata),c(e))},function(e){o.error("Error fetching data: "+e),l()})};Promise.all([u,d]).then(function(e){return n._refreshId!==s?null:c(e)},function(e){o.error("Error fetching data: "+e),l()}).then(function(e){n._refreshId===s?(t(e),l()):l()})}}},function(e){o.error("Error fetching data: "+e),i()})},_renderItems:function(e,t){for(var i=n(document.createElement("ul")).addClass("oj-treeview-list").attr("role","group").appendTo(t),r=0;r<e.data.length;r++)this._renderItem(i,e,r)},_renderItem:function(e,t,i,r,a){var o,l,d=t.data[i],h=t.metadata[i],u=h.key;if(!a){if(this._keyList.has(u))throw new Error("JET TreeView nodes should not have duplicated keys: "+u);this._keyList.add(u)}var c=n(document.createElement("li")).attr("id",u);if(a){var _=this._getItemByKey(u)[0];e=n(_.parentNode),_.parentNode.replaceChild(c[0],_)}else null==r||r>=e.children().length?c.appendTo(e):c.insertBefore(e.children()[r]);var p={};p.parentElement=c,p.index=i,p.data=d,p.datasource=this.options.data,p.parentKey=this._getKey(this._getParentItem(c)),p.component=s.__GetWidgetConstructor(this.element),this._FixRendererContext&&(p=this._FixRendererContext(p));var f=this.m_dataSource.getChildDataProvider(u);h.leaf=null===f||"yes"===f.isEmpty(),h.depth=this._getDepth(c[0]);var g=Object.keys(h);for(o=0;o<g.length;o++){var m=g[o];p[m]=h[m]}var v=this.options.item.renderer;v=this._WrapCustomElementRenderer(v);var y=this._getItemTemplate(),E=this._getTemplateEngine();if(null!=v){var C=v.call(this,p);null!=C&&(null===C.parentNode||C.parentNode instanceof DocumentFragment?c.append(C):null!=C.parentNode||C.toString&&((l=document.createElement("span")).appendChild(document.createTextNode(C.toString())),c.append(l)))}else if(null!=y&&null!=E){var I=this.element[0],j=E.execute(I,y,p,null);for(o=0;o<j.length;o++){if("LI"===j[o].tagName){c.replaceWith(j[o]);break}c.append(j[o])}}else(l=document.createElement("span")).appendChild(document.createTextNode(null==d?"":d.toString())),c.append(l);c=e.children().eq(null!=r?r:i),p.parentElement=c,null==c.attr("id")&&c.attr("id",u),c.data("data",d).data("metadata",h),this._decorateItem(c)},_getDepth:function(e){for(var t=0,n=e;n&&n!==this.element[0];)n=n.parentElement.parentElement,t+=1;return t},_loadTemplateEngine:function(){var e=this;return null!=this._getItemTemplate()&&null==e.options.item.renderer?new Promise(function(t){l.__getTemplateEngine().then(function(n){e.m_engine=n,t(n)},function(e){throw new Error("Error loading template engine: "+e)})}):Promise.resolve(null)},_getTemplateEngine:function(){return this.m_engine},_getItemTemplate:function(){if(void 0===this.m_template){this.m_template=null;var e=this._getSlotMap().itemTemplate;e&&e.length>0&&"template"===e[0].tagName.toLowerCase()&&(this.m_template=e[0])}return this.m_template},_getSlotMap:function(){return t.BaseCustomElementBridge.getSlotMap(this.element[0])},_decorateTree:function(){var e=this,t=this._getRoot();this._focusable({element:t,applyHighlight:!0,setupHandlers:function(t,n){e._focusInHandler=t,e._focusOutHandler=n}}),t.attr("tabIndex",0).on("focus",function(){e._focusInHandler(e._getItemContent(e._currentItem))}).on("blur",function(){e._focusOutHandler(e._getItemContent(e._currentItem))}).attr("role","tree").attr("aria-labelledby",this.element.attr("id"));var n=this.options.selectionMode;"none"!==n?t.attr("aria-multiselectable","multiple"===n?"true":"false"):t.removeAttr("aria-multiselectable")},_decorateItem:function(e){e.addClass("oj-treeview-item").attr("role","treeitem");var t=this._getItemContent(e);0===t.length&&((t=n(document.createElement("div")).addClass("oj-treeview-item-content").append(e.contents()).appendTo(e)).children("ul").appendTo(e),t.find(".oj-treeview-item-icon").addClass("oj-treeview-icon")),this._select(e);var i=this._getDragOptions();t.attr("draggable",Object.keys(i).length>0?"true":"false");var r=e.children(".oj-treeview-spacer");0===r.length&&(r=n(document.createElement("ins")).addClass("oj-treeview-icon oj-treeview-spacer").prependTo(e)),this._isLeaf(e)?e.addClass("oj-treeview-leaf"):(this._isInitExpanded(e)?this._expand(e,!1):this._collapse(e,!1),r.addClass("oj-treeview-disclosure-icon oj-component-icon oj-clickable-icon-nocontext oj-default"))},_getItems:function(){return this.element.find(".oj-treeview-item")},_getKey:function(e){var t=e.data("metadata");return t?t.key:e.attr("id")},_getItemByKey:function(e){var i=this.element.find("li").filter(function(){var i=n(this).data("metadata");return!!i&&t.Object.compareValues(i.key,e)});return i.length>0?i:this.element.find("li#"+n.escapeSelector(e))},_getItemContent:function(e){return e.children(".oj-treeview-item-content")},_getChildItems:function(e){return e.children(".oj-treeview-list").children(".oj-treeview-item")},_getParentItem:function(e){return e.parent(".oj-treeview-list").parent(".oj-treeview-item")},_getSubtree:function(e){return e.children(".oj-treeview-list")},_getRoot:function(){return this.element.children(".oj-treeview-list")},_isLeaf:function(e){var t=e.data("metadata");return!(t?!t.leaf:this._getSubtree(e).length>0)},_isInitExpanded:function(e,t){var n=this._getKey(e),i=null!=t?t:this.options.expanded;return!(!i||!i.has)&&i.has(n)},_isExpanded:function(e){return e.hasClass("oj-expanded")},_isDisclosing:function(e){return!(!e||!this.m_disclosing)&&this.m_disclosing.indexOf(e)>-1},_setDisclosing:function(e,t){if(null!=e)if(null==this.m_disclosing&&(this.m_disclosing=[]),t)this.m_disclosing.push(e);else for(var n=this.m_disclosing.indexOf(e);n>-1;)this.m_disclosing.splice(n,1),n=this.m_disclosing.indexOf(e)},_expand:function(e,t,n,i){var r=this;if(!(this._isExpanded(e)||this._isLeaf(e)||t&&this._isDisclosing(this._getKey(e)))){if(t&&!this._trigger("beforeExpand",n,this._getEventPayload(e))&&!1!==i)return;if(this._lastSelectedItem=null,0===this._getSubtree(e).length)return this._uiExpanded=this._uiExpanded.add([r._getKey(e)]),void this._fetchChildren(r._getKey(e),function(i){if(!r._isExpanded(e)&&(r._isInitExpanded(e)||r._isInitExpanded(e,r._uiExpanded))){var s=i[0];r._renderItems(s.value,e),r._expandAfterFetch(e,t,n)}});r._expandAfterFetch(e,t,n)}},_expandAfterFetch:function(e,t,n){var i=this;e.removeClass("oj-collapsed").addClass("oj-expanded").attr("aria-expanded","true");var r=this._getSubtree(e);if(r.css("display","block"),t){var s=this._addBusyState("animating expand");e.addClass("oj-treeview-animated"),i._setDisclosing(i._getKey(e),!0),this._startAnimation(r,"expand").then(function(){i._setDisclosing(i._getKey(e),!1),e.removeClass("oj-treeview-animated"),i._trigger("expand",n,i._getEventPayload(e));var t=i.options.expanded.add([i._getKey(e)]);i._userOptionChange("expanded",t,n),s()})}},_collapse:function(e,t,n,i){var r=this;if(!(e.hasClass("oj-collapsed")||this._isLeaf(e)||t&&this._isDisclosing(this._getKey(e)))){if(t){if(!this._trigger("beforeCollapse",n,this._getEventPayload(e))&&!1!==i)return;this._setDisclosing(this._getKey(e),!0)}e.removeClass("oj-expanded").addClass("oj-collapsed").attr("aria-expanded","false"),this._lastSelectedItem=null;var s=this._getSubtree(e);if(t){var a=this._addBusyState("animating collapse");e.addClass("oj-treeview-animated"),this._uiExpanded=this._uiExpanded.delete([this._getKey(e)]),this._startAnimation(s,"collapse").then(function(){r._setDisclosing(r._getKey(e),!1),s.css("display","none"),e.removeClass("oj-treeview-animated"),r._trigger("collapse",n,r._getEventPayload(e));var t=r.options.expanded.delete([r._getKey(e)]);r._userOptionChange("expanded",t,n),a()})}else s.css("display","none")}},_startAnimation:function(e,t){this.defaultOptions||(this.defaultOptions=r.parseJSONFromFontFamily("oj-treeview-option-defaults"));var n=(this.defaultOptions.animation||{})[t];return a.startAnimation(e[0],t,n,this)},_getEventPayload:function(e){return{key:this._getKey(e),item:e[0]}},_isActionable:function(e,t){var n=this.options.item[t+"able"];return!1!==n&&("function"!=typeof n||n(this.getContextByNode(e[0])))},_isSelected:function(e){var t=this.options.selectionMode,n=this.options.selection;if("none"===t)return!1;"single"===t&&n.length>1&&(n=[n[0]]);var i=this._getKey(e);return-1!==n.indexOf(i)},_select:function(e,n){var i=this.options.selectionMode;if("none"!==i&&this._isActionable(e,"select")){var r=this._isSelected(e);if(n){var s=n.originalEvent.sourceCapabilities&&n.originalEvent.sourceCapabilities.firesTouchEvents,a=t.DomUtils.isTouchSupported()&&(s||null!=this.touchStartEvent&&this.touchStartEvent.target===n.target),o=t.DomUtils.isMetaKeyPressed(n),l="multiple"===i,d=40===n.keyCode||38===n.keyCode,h=this._getKey(e),u=[];if(l&&n.shiftKey&&!d){o?u=this.options.selection.slice(0):this._clearSelection();for(var c=this._lastSelectedItem,_=c&&c.offset().top<e.offset().top?this._getNextActionableItem.bind(this):this._getPreviousActionableItem.bind(this);c&&c[0]!==e[0];){var p=this._getKey(c);-1===u.indexOf(p)&&(u.push(p),this._setSelected(c)),c=_(c,"select")}r=!0,u.push(h)}else l&&(o||a||d)?(r=!r,u=this.options.selection.slice(0),r?u.push(h):u.splice(u.indexOf(h),1)):(this._clearSelection(),(a||32===n.keyCode)&&r?(r=!1,u=[]):(r=!0,u=[h]));this._userOptionChange("selection",u,n),this._lastSelectedItem=e}r?this._setSelected(e):this._setUnselected(e)}},_setSelected:function(e){this._getItemContent(e).addClass("oj-selected"),e.attr("aria-selected","true")},_setUnselected:function(e){this._getItemContent(e).removeClass("oj-selected"),e.attr("aria-selected","false")},_clearSelection:function(){this._setUnselected(this._getItems())},_focus:function(e,t){if(this._isActionable(e,"focus")){if(t){var n=this._getEventPayload(e);if(this._currentItem&&(n.previousKey=this._getKey(this._currentItem),n.previousItem=this._currentItem[0]),!this._trigger("beforeCurrentItem",t,n))return;this._userOptionChange("currentItem",this._getKey(e),t)}this._focusOutHandler(this._getItemContent(this._currentItem)),this._focusInHandler(this._getItemContent(e)),this._setCurrentItem(e)}},_resetFocus:function(){if(this.options.currentItem){var e=this._getItemByKey(this.options.currentItem);if(e.length>0)return void this._setCurrentItem(e)}var t=this._getItems().first();this._setCurrentItem(t),this._userOptionChange("currentItem",this._getKey(this._currentItem),null)},_setCurrentItem:function(e){this._currentItem=e,this._getRoot().attr("aria-activedescendant",this._getKey(e))},_addBusyState:function(e){var t=i.getContext(this.element[0]).getBusyContext(),n=this.element.attr("id");return t.addBusyState({description:"The component identified by '"+n+"', "+e})},_userOptionChange:function(e,t,n){this.option(e,t,{_context:{originalEvent:n,writeback:!0,internalSet:!0}})},_getDragOptions:function(){return((this.options.dnd||{}).drag||{}).items||{}},_getDropOptions:function(){return((this.options.dnd||{}).drop||{}).items||{}},_getClosestItem:function(e){return e.closest(".oj-treeview-item")},_getClosestItemContent:function(e){return e.closest(".oj-treeview-item-content")},_getClosestDisclosureIcon:function(e){return e.closest(".oj-treeview-disclosure-icon")},_handleClick:function(e){var t,i=this._getClosestDisclosureIcon(n(e.target));if(i.length>0)return t=i.closest(".oj-treeview-item"),this._isExpanded(t)?this._collapse(t,!0,e):this._expand(t,!0,e),void(this.touchStartEvent=null);var r=this._getClosestItemContent(n(e.target));if(r.length>0)return t=r.parent(),this._select(t,e),this._focus(t,e),void(this.touchStartEvent=null);"none"!==this.options.selectionMode&&(this._clearSelection(),this._lastSelectedItem=null,this._userOptionChange("selection",[],e)),this.touchStartEvent=null},_handleMouseOver:function(e){if(!t.DomUtils.isTouchSupported()||!this.touchStartEvent){var i=this._getClosestDisclosureIcon(n(e.target));0===i.length&&(i=this._getClosestItemContent(n(e.target))),i.removeClass("oj-default"),i.addClass("oj-hover")}},_handleMouseOut:function(e){var t=this._getClosestDisclosureIcon(n(e.target));t.removeClass("oj-selected"),0===t.length&&(t=this._getClosestItemContent(n(e.target))),t.addClass("oj-default"),t.removeClass("oj-hover")},_handleMouseDown:function(e){this._getClosestDisclosureIcon(n(e.target)).addClass("oj-selected")},_handleMouseUp:function(e){this._getClosestDisclosureIcon(n(e.target)).removeClass("oj-selected")},_handleKeyDown:function(e){var t,n=e.keyCode,i=this._currentItem;if(38===n||40===n)(t=40===n?this._getNextActionableItem(i,"focus"):this._getPreviousActionableItem(i,"focus"))&&(e.preventDefault(),this._isSelected(i)&&e.shiftKey&&this._select(this._isSelected(t)?i:t,e),this._focus(t,e));else if(37===n||39===n){var r="rtl"===this._GetReadingDirection(),s=!r&&39===n||r&&37===n;!s||this._isLeaf(i)||this._isExpanded(i)?s||this._isLeaf(i)||!this._isExpanded(i)?(t=s?this._getNextActionableItem(i,"focus"):this._getPreviousActionableItem(i,"focus"))&&(e.preventDefault(),this._focus(t,e)):(e.preventDefault(),this._collapse(i,!0,e)):(e.preventDefault(),this._expand(i,!0,e))}else 13!==n&&32!==n||(e.preventDefault(),this._select(i,e))},_getNextItem:function(e){if(!this._isLeaf(e)&&this._isExpanded(e)){var t=this._getChildItems(e).first();if(t.length>0)return t}for(var n=e;n.length>0;){var i=n.next(".oj-treeview-item");if(i.length>0)return i;n=this._getParentItem(n)}return null},_getNextActionableItem:function(e,t){for(;null!=e;)if(null!=(e=this._getNextItem(e))&&this._isActionable(e,t))return e;return null},_getPreviousItem:function(e){for(var t=e.prev(".oj-treeview-item");t.length>0;){if(this._isLeaf(t)||!this._isExpanded(t))return t;var n=this._getChildItems(t).last();if(!(n.length>0))return t;t=n}var i=this._getParentItem(e);return i.length>0?i:null},_getPreviousActionableItem:function(e,t){for(;null!=e;)if(null!=(e=this._getPreviousItem(e))&&this._isActionable(e,t))return e;return null},_handleDragStart:function(e){var i=this,r="rtl"===this._GetReadingDirection(),s=this._getClosestItem(n(e.target));if(0!==s.length){var a,o=n();if(this._isSelected(s)){var l=this.options.selection;for(a=0;a<l.length;a++)o=o.add(this._getItemByKey(l[a]))}else this._select(s,e),o=o.add(s);var d=this._getDragOptions(),h=e.originalEvent.dataTransfer,u=n(document.createElement("ul")).addClass("oj-treeview-drag-image oj-treeview-list");t.AgentUtils.getAgentInfo().browser===t.AgentUtils.BROWSER.SAFARI&&u.css("position","absolute");var c=[],_=1/0,p=1/0;o.each(function(){var e=n(this);c.push(e.data("data"));var t=e.offset();r&&(t.left=i._getItemContent(e).offset().left);var s=e.clone().css({top:t.top,left:t.left});i._getSubtree(s).remove(),t.top<_&&(_=t.top),t.left<p&&(p=t.left),u.append(s)}),u.children().each(function(){n(this).css({top:parseFloat(n(this).css("top"))-_,left:parseFloat(n(this).css("left"))-p})});var f=d.dataTypes,g="string"==typeof f?[f]:f||[];for(a=0;a<g.length;a++)h.setData(g[a],JSON.stringify(c));n("body").append(u),h.setDragImage(u[0],e.pageX-p,e.pageY-_),setTimeout(function(){u.remove()},0);var m=d.dragStart;m&&m(e.originalEvent,{items:c})}},_handleDragSourceEvent:function(e,t){var n=this._getDragOptions()[t];n&&n(e.originalEvent)},_handleDropTargetEvent:function(e,t){var i=this._getDropOptions(),r=i.dataTypes,s="string"==typeof r?[r]:r||[],a=i[t],o=n(e.target).closest(".oj-treeview-item"),l=o.children(".oj-treeview-spacer")[0],d=l.getBoundingClientRect(),h=l.offsetTop,u=l.offsetLeft,c=h+d.height/2,_="inside",p=e.pageY-d.top;p<.25*d.height?_="before":p>.75*d.height&&(_=this._isExpanded(o)?"first":"after"),a&&a(e.originalEvent,{item:o[0],position:_});for(var f=0;f<s.length;f++){var g=e.originalEvent.dataTransfer.types;if(g&&g.indexOf(s[f])>=0){e.preventDefault();break}}if("dragEnter"!==t&&"dragOver"!==t||!e.originalEvent.defaultPrevented)this._dropMarker.hide(),this._dropLine.hide();else{var m="rtl"===this._GetReadingDirection(),v=c,y=m?u-this._dropLineRect.width:u+d.width,E=c-this._dropMarkerRect.height/2,C=u+d.width/2-this._dropMarkerRect.width/2;if("before"===_)E-=d.height/2,v-=d.height/2;else if(("after"===_||"first"===_)&&(E+=d.height/2,v+=d.height/2,"first"===_)){var I=(m?-1:1)*d.width;C+=I,y+=I}this._dropMarker.css("top",E+"px").css("left",C+"px").show(),"inside"!==_?this._dropLine.css("top",v+"px").css("left",y+"px").show():this._dropLine.hide()}},_NotifyContextMenuGesture:function(e,t,n){if("keyboard"===n){var i=this._currentItem?this._getItemContent(this._currentItem):this.element,r={launcher:i,initialFocus:"menu",position:{my:"start top",at:"start bottom",of:i}};this._OpenContextMenu(t,n,r)}else this._superApply(arguments)},refresh:function(){this._super(),this._refreshId+=1,delete this.m_template,delete this.m_engine,delete this.m_dataSource,this._render()},getNodeBySubId:function(e){if(null==e)return this.element?this.element[0]:null;var t,n=e.key,i=e.subId,r=this._getItemByKey(n);return"oj-treeview-disclosure"===i?t=r.children(".oj-treeview-disclosure-icon")[0]:"oj-treeview-item"===i&&(t=r.children(".oj-treeview-item-content")[0]),t||null},getSubIdByNode:function(e){if(!n.contains(this.element[0],e))return null;var t,i=this._getClosestDisclosureIcon(n(e)),r=this._getClosestItem(n(e));if(i.length>0)t="oj-treeview-disclosure";else{if(!(r.length>0))return null;t="oj-treeview-item"}return{subId:t,key:this._getKey(r)}},getContextByNode:function(e){if(!n.contains(this.element[0],e))return null;var t=this._getClosestItem(n(e));if(t.length<1)return null;var i={subId:"oj-treeview-item"};i.index=t.parent().children(".oj-treeview-item").index(t),i.parentKey=this._getKey(this._getParentItem(t)),i.component=s.__GetWidgetConstructor(this.element),this._FixRendererContext&&(i=this._FixRendererContext(i));var r=t.data("metadata");if(r){i.data=t.data("data"),i.datasource=this.options.data;for(var a=Object.keys(r),o=0;o<a.length;o++){var l=a[o];i[l]=r[l]}}else i.key=this._getKey(t),i.leaf=this._isLeaf(t),i.depth=t.parents(".oj-treeview-list").length;return i},_setOption:function(e,t,i){var r=this;this._superApply(arguments),"expanded"===e?(this._uiExpanded=r._uiExpanded.clear(),this._getItems().each(function(){var e=n(this);r._isInitExpanded(e)?r._expand(e,!0):r._collapse(e,!0)})):"selection"===e?this._getItems().each(function(){var e=n(this);r._select(e)}):"currentItem"===e?this._resetFocus():this.refresh()},_SetupResources:function(){this._super(),this._addDataProviderEventListeners()},_ReleaseResources:function(){this._super(),this._removeDataProviderEventListeners()},_destroy:function(){this._removeDataProviderEventListeners(),this._super()},_addDataProviderEventListeners:function(){var e=this.options.data;e&&t.DataProviderFeatureChecker.isTreeDataProvider(e)&&(this.m_handleModelMutateEventListener=this.handleModelMutateEvent.bind(this),this.m_handleModelRefreshEventListener=this.handleModelRefreshEvent.bind(this),e.addEventListener("mutate",this.m_handleModelMutateEventListener),e.addEventListener("refresh",this.m_handleModelRefreshEventListener))},_removeDataProviderEventListeners:function(){var e=this.options.data;e&&t.DataProviderFeatureChecker.isTreeDataProvider(e)&&(e.removeEventListener("mutate",this.m_handleModelMutateEventListener),e.removeEventListener("refresh",this.m_handleModelRefreshEventListener))},handleModelMutateEvent:function(e){null!=e.detail.remove&&this.handleModelRemoveEvent(e),null!=e.detail.add&&this.handleModelAddEvent(e),null!=e.detail.update&&this.handleModelChangeEvent(e)},handleModelRemoveEvent:function(e){var t=this,n=e.detail.remove.keys,i=[];if(null!=n&&0!==n.size){n.forEach(function(e){i=i.concat(t._removeAllChildrenOfParentKey(e))});var r=this.options.selected;if(null!=r){var s=r.delete(i);r!==s&&this._userOptionChange("selection",s,null)}var a=this.options.expanded;if(null!=a){var o=a.delete(i);this._uiExpanded.delete(i),a!==o&&this._userOptionChange("expanded",o,null)}this._resetFocus()}},_removeAllChildrenOfParentKey:function(e){var t=this,i=[],r=this._getItemByKey(e);return this._getChildItems(r).each(function(e,r){var s=t._getKey(n(r)),a=t._removeAllChildrenOfParentKey(s);i=i.concat(a)}),r[0].parentNode.removeChild(r[0]),this._keyList.delete(e),i.push(e),i},handleModelAddEvent:function(e){var t,i=e.detail.add,r=i.data,s=i.metadata,a=[],o=i.parentKeys,l=i.indexes;i.keys.forEach(function(e){a.push(e)});var d=i.addBeforeKeys?i.addBeforeKeys:i.afterKeys;if(d&&(t=[],d.forEach(function(e){t.push(e)})),null!=r&&null!=a&&a.length>0&&r.length>0&&a.length===r.length&&(null==l||l.length===r.length))for(var h=0;h<r.length;h++){var u,c=null==l?this._getIndex(t,h)+1:l[h],_=o[h];if(null==_)u=this._getRoot(),this._renderItem(u,{data:[r[h]],metadata:[s[h]]},0,c);else if(this._isInitExpanded(_)){var p=this._getItemByKey(_);0===(u=this._getSubtree()).length&&(u=n(document.createElement("ul")).addClass("oj-treeview-list").attr("role","group").appendTo(p)),this._renderItem(u,{data:[r[h]],metadata:[s[h]]},0,c)}}},handleModelChangeEvent:function(e){for(var t=e.detail.update,n=t.data,i=t.metadata,r=t.keys,s=0;s<n.length;s++)null!=this._getItemByKey(r[s])&&this._renderItem(null,{data:[n[s]],metadata:[i[s]]},0,null,!0);this._resetFocus()},handleModelRefreshEvent:function(){this.refresh()}}),d.extension._WIDGET_NAME="ojTreeView",t.CustomElementBridge.register("oj-tree-view",{metadata:d})});