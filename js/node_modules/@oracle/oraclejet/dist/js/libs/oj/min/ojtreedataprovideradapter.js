/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovideradapter-base","ojs/ojmap"],function(t,e,n,r){"use strict";var a=function(e){function n(t){var n=e.call(this,t)||this;return n.treeDataSource=t,n._addTreeDataSourceEventListeners(),n._parentKey=null,n._parentInfoMap=new r,n}return __extends(n,e),n.prototype.destroy=function(){this._removeTreeDataSourceEventListeners()},n.prototype.getChildDataProvider=function(t){if(this._parentInfoMap.has(t)){var e=new n(this.treeDataSource);return e._parentKey=t,e._parentInfoMap=this._parentInfoMap,e}return null},n.prototype.fetchFirst=function(t){return new this.AsyncIterable(new this.AsyncIterator(this._getFetchFunc(t),t))},n.prototype.getTotalSize=function(){return Promise.resolve(this.treeDataSource.getChildCount(this._parentKey))},n.prototype.isEmpty=function(){var t=this.treeDataSource.getChildCount();return-1===t?"unknown":t>0?"no":"yes"},n.prototype.getCapability=function(t){return t==n._SORT&&"full"==this.treeDataSource.getCapability(t)?{attributes:"multiple"}:"fetchByKeys"==t?{implementation:"iteration"}:"fetchByOffset"==t?{implementation:"iteration"}:null},n.prototype._getFetchFunc=function(t){var e=this;return null!=t&&null!=t[n._SORTCRITERIA]?function(t,r){return function(a,i){if(i){var o={};return o[n._KEY]=t,o[n._DIRECTION]=r,new Promise(function(t,n){e.treeDataSource.sort(o,{success:function(){t(e._getTreeDataSourceFetch(a)(a))},error:function(t){n(t)}})})}return e._getTreeDataSourceFetch(a)(a)}}(t[n._SORTCRITERIA][0][n._ATTRIBUTE],t[n._SORTCRITERIA][0][n._DIRECTION]):this._getTreeDataSourceFetch(t)},n.prototype._getTreeDataSourceFetch=function(t){var e=this;return function(t,r){var a=e.treeDataSource.getSortCriteria();if(null!=a&&"none"!=a[n._DIRECTION]&&null==t[n._SORTCRITERIA]){t[n._SORTCRITERIA]=[];var i=new e.SortCriterion(e,a[n._KEY],a[n._DIRECTION]);t[n._SORTCRITERIA].push(i)}return e._isFetching=!0,new Promise(function(r,a){e.treeDataSource.fetchChildren(e._parentKey,{start:0,end:-1},{success:function(a){e._isFetching=!1;var i,o,s,u=[],h=[],c=a.getStart(),p=a.getCount();for(i=0;i<p;i++)o=a.getData(c+i),u.push(o),(s=a.getMetadata(c+i))[n._LEAF]||e._parentInfoMap.set(s[n._KEY],s),h.push(new e.ItemMetadata(e,s[n._KEY]));r(new e.AsyncIteratorResult(e,new e.FetchListResult(e,t,u,h),!0))},error:function(t){e._isFetching=!1,a(t)}})})}},n.prototype._addTreeDataSourceEventListeners=function(){this.removeAllListeners(),this.addListener("change",this._handleChange),this.addListener("refresh",this._handleRefresh)},n.prototype._removeTreeDataSourceEventListeners=function(){this.removeListener("change"),this.removeListener("refresh")},n.prototype._handleChange=function(t){var e=t[n._OPERATION];"insert"===e?this._handleInsert(t):"delete"===e?this._handleDelete(t):"update"===e&&this._handleUpdate(t)},n.prototype._handleInsert=function(e){var r=e[n._DATA],a=e[n._INDEX],i=e[n._KEY],o=e[n._PARENT],s=new this.ItemMetadata(this,i),u=new Set;u.add(i);var h=e[n._METADATA];null!=h&&h[n._LEAF]&&this._parentInfoMap.set(i,h);var c=new this.DataProviderAddOperationEventDetail(this,u,null,null,[o],[s],[r],[a]),p=new this.DataProviderMutationEventDetail(this,c,null,null);this.dispatchEvent(new t.DataProviderMutationEvent(p))},n.prototype._handleDelete=function(e){var r=e[n._DATA],a=e[n._INDEX],i=e[n._KEY],o=new this.ItemMetadata(this,i),s=new Set;s.add(i),this._parentInfoMap.delete(i);var u=new this.DataProviderOperationEventDetail(this,s,[o],[r],[a]),h=new this.DataProviderMutationEventDetail(this,null,u,null);this.dispatchEvent(new t.DataProviderMutationEvent(h))},n.prototype._handleUpdate=function(e){var r=e[n._DATA],a=e[n._INDEX],i=e[n._KEY],o=new this.ItemMetadata(this,i),s=new Set;s.add(i);var u=new this.DataProviderOperationEventDetail(this,s,[o],[r],[a]),h=new this.DataProviderMutationEventDetail(this,null,null,u);self.dispatchEvent(new t.DataProviderMutationEvent(h))},n.prototype._handleRefresh=function(e){this._isFetching||(this._parentInfoMap.clear(),this.dispatchEvent(new t.DataProviderRefreshEvent))},n._SORTCRITERIA="sortCriteria",n._INDEX="index",n._PARENT="parent",n._LEAF="leaf",n._OPERATION="operation",n}(n);return t.TreeDataSourceAdapter=a,t.TreeDataSourceAdapter=a,t.FetchByKeysMixin.applyMixin(a),t.FetchByOffsetMixin.applyMixin(a),a});